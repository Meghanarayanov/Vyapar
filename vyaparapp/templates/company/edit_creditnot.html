<!-- create by Antony Tom -->
{% extends 'company/src/html/base.html' %}
{% block content %}
{% load static %}

<script src="//code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

<style>
    .card-body {
        box-shadow: 2px 2px 10px 3px rgba(0, 0, 0, 0.397);
        border-radius: 1vh;
    }

    #tab_logic {
        margin-left: 10px;
        width: 98%;
    }

    #tab_logic thead th {
        border-bottom: 1px solid black;
        border-top: 1px solid black;
        border-left: 1px solid black;
        border-right: 1px solid black;
        background-color: rgba(0, 195, 255, 0.205);
    }

    #tab_logic tbody td {
        border-bottom: 1px solid black;
        border-top: 1px solid black;
        border-left: 1px solid black;
        border-right: 1px solid black;
    }

    .form-control {
        border: 1px solid lightblue;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        border-color: #007bffb1;
    }

    .table>:not(caption)>*>* {
        padding: 16px 5px !important;
    }

    .form-control {
        padding: 8px 7px;
    }

    .save-button {
        background-color: #007bff;
        border-color: #007bff;
        color: #fff;
        margin-right: 1rem;
    }


    .save-button:hover {
        background-color: #fff;
        color: #007bff;
    }

    .selectize-input {
        height: 5vh;
        border-color: #54B4D3;
        border-radius: 5px;
    }

    .unit-modal {
        margin-left: 350px;
        display: none;
        position: fixed;
        z-index: 1051;
        /* Ensure it has a higher z-index than Bootstrap modal */
        left: 0;
        top: 40px;
        width: 50%;
        height: 70%;
        overflow: hidden;



    }




    .unit-modal-content {
        
        margin: 15% auto;
        padding: 20px;
        border: 1px solid #888;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        width: 80%;
        z-index: 1052;
        background-color: white;

    }

    .close-btn {
        color: #aaaaaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
    }

    .close-btn:hover,
    .close-btn:focus {
        color: #000;
        text-decoration: none;
        cursor: pointer;
    }
</style>




<div class="body-wrapper">
    <br><br><br>
    <div class="row p-0 m-0">
        <div class="col-12  p-0 m-0">
            <div class=" bg-light bg-light pb-0 mb-0 p-2" style="height:100%;width:100%">
                <div class="d-flex justify-content-center pt-4">
                    <a href="{% url 'add_salesinvoice' %}" id="b1" class="btn  text-white"
                        style="margin-right: 10px; background-color: rgb(252, 3, 3,0.7);border-radius: 20px;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
                        Add Sale <i class="fa fa-plus"></i>
                    </a>
                    <a href="{% url 'add_purchasebill' %}" id="b2" class="btn  text-white"
                        style="margin-right: 10px;background-color: rgba(3, 161, 252, 0.7);border-radius: 20px;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
                        Add Purchase <i class="fa fa-plus"></i>
                    </a>
                    <a href="" id="b3" class="btn text-primary"
                        style="border-radius: 20px;border: 1px solid rgb(40, 12, 222);background-color: white;box-shadow: 0 4px 8px 0 rgba(0, 0, 0, 0.2), 0 6px 20px 0 rgba(0, 0, 0, 0.19);">
                        Add More <i class="fa fa-plus"></i>
                    </a>
                </div>
                <p></p>

                <form method="POST" action="{% url 'update_creditnote' credit.id %}"
                    enctype="multipart/form-data" novalidate id="forms">
                    {% csrf_token %}


                    <div class="page-content">
                        <div class="card radius-15">
                            <div class="card-body bg-light">
                                <div class="row">
                                    <div class="col-md-4">
                                        <h3 class="mb-3">EDIT &nbsp; SALES &nbsp; INVOICE
                                        </h3>
                                        <h6 id="errorMessage" class="text-danger"></h6>
                                    </div>
                                    <div class="col-md-7"></div>
                                    <div class="col-md-1">
                                        <a href="javascript:window.history.back();"
                                            style="text-align: right; font-size: large; color: black; margin-left: 8vh;">
                                            <i class="fa fa-times mt-3" aria-hidden="true"></i>
                                        </a>
                                    </div>
                                </div>

                                <div id="customer_div" style="margin-left: .1px; margin-right: .51px;">

                                    <div id="customer_div" style="margin-left: .1px; margin-right: .51px;">
                                        <div class="row">
                                            <div class="col-md-4">
                                                <label class="col-form-label">Party Name</label>
                                                <div class="d-flex">
                                                  <select name="partyname" id="partySelect" class="form-control border-secondary select2" style="color: black; background-color: white;">
                                                      <option value="{{credit.party.id}}" selected>{{credit.party.party_name}}</option>
                                                      {% for p in party %}
                                                          {% if p.cid_id == cmp.cid and p.id != credit.party.id %}
                                                              <option value="{{p.id}}" data-state="{{ p.State }}">{{ p.party_name }}</option>
                                                          {% endif %}
                                                      {% endfor %}
                                                  </select>
                                                   &nbsp;&nbsp;&nbsp;
                                                   <script>
                                                        $(document).ready(function() {
                                                            $('#partySelect').selectize(); 
                                                            updatePartyDropdown(); 
                                                        });
                                                    </script>


                                                <button id="modal_closing" type="button" class="btn btn-outline-info"
                                                    style="margin-top: -4px;" data-bs-toggle="modal"
                                                    data-bs-target="#customercreation" data-bs-whatever="@mdo"><span
                                                        class="fa fa-plus " ></span></button>

                                            </div>
                                        </div>

                                        
                                        <div class="col-md-4">
                                            <div id="partyPhonebox">
                                                <label class="col-form-label">Phone No</label>
                                                <input style="color: black; width: 21.5vw;"
                                                    class="form-control bg-white border-secondary" type="tel"
                                                    placeholder="Phone No" autocomplete="off" name="contact"
                                                    id="partyPhone" value="{{credit.contact}}" readonly>
                                            </div>
                                        </div>
                                        
                                        <div class="col-md-4">
                                            <div id="partyAddressbox">
                                                <label class="col-form-label">Address</label>
                                                <input style="color: black; width: 21.5vw;"
                                                    class="form-control bg-white border-secondary" type="text"
                                                    placeholder="Address" autocomplete="off" name="address"
                                                    id="partyAddress" value="{{credit.address}}" readonly>
                                            </div>
                                        </div>
                                    </div>

                                    <label for="" id="partyBalance">Balance Amount: </label>

                                    <div class="row">
                                        <div class="col-md-4" id="addressdiv">
                                            <label class="col-form-label">Reference No.</label>
                                            <input type="text" class="form-control border-secondary" name="creditno" value="{{credit.retrn_no}}"  style="color: black;background-color: white;" readonly> <br>
                                         </div>
                                        <div class="col-md-4">
                                            <label class="col-form-label">Return  Date</label>
                                            <input type="date" class="form-control border-secondary" name="cr_date" value="{{bdate}}"  id="date1" style="color: black;background-color: white; width: 330px;" value='{{tod}}'>
                                            <br>
                                        </div>
                                        <div class="col-md-4 mb-4" style="width: 350px;">
                                            <label class="col-form-label">Invoice No.</label>
                                            <select class="form-control border-secondary" name="inv_no" id="inv_no" style="color: black; background-color: white;">
                                                <option value="{{credit.invoiceno}}" selected>{{credit.invoiceno}}</option>
                                                
                                            </select>
                                        </div>
                                    
                                        <div class="col-md-4 mb-4" >
                                            <label class="col-form-label">Invoice Date</label>
                                            <select class="form-control border-secondary" name="inv_date" id="inv_date" style="color: black; background-color: white; width: 370px;">
                                                {% if credit.invoice_date == '0000-00-00' %}
                                                    <option value="nodate" selected hidden>nodate</option>
                                                {% else %}
                                                    <option value="{{ credit.invoice_date }}" selected hidden>{{ credit.invoice_date }}</option>
                                                {% endif %}
                                                <!-- No need to add options dynamically -->
                                            </select>
                                        </div>
                                    
                                        <div class="col-md-4 mb-4" style="width: 350px;">
                                            <label class="col-form-label">Place of supply</label>
                                            <select style="color: black; width: 22.5vw;" class="form-control bg-white me-2 border-secondary" id="stateOfSupply" name="destination">
                                                <option value="{{credit.supplyplace}}" selected hidden>{{credit.supplyplace}}</option>
                                                <option value="State">State</option>
                                                <option value="Other State">Other State</option>
                                            </select>
                                        </div>
                                    
                                       &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;
                                        <div class="col-md-4">
                                        
                                            {% if credit.pay_method != 'Cash' and credit.pay_method != 'Cheque' and credit.pay_method != 'UPI' %}
                                            <label class="col-form-label">Payment Method</label>
                                            <select class="form-control border-secondary my-select" id="pay_method" name="method" style="color: black;background-color: white;">
                                                <option value="{{bankno.id}}" selected hidden>{{bankno.bank_name}}</option>
                                                <option value="Cash">Cash</option>
                                                <option value="Cheque">Cheque</option>
                                                <option value="UPI">UPI</option>
                                                {% for b in bank %}
                                                    <option value="{{b.id}}">{{b.bank_name}} (...{{ b.last_four_digits}})</option>
                                                {% endfor %}
                                            </select>
                                            {% else %}
                                                <label class="col-form-label">Payment Method</label>
                                                <select class="form-control border-secondary my-select" id="pay_method" name="method" style="color: black;background-color: white; width: 350px;">
                                                    <option value="{{credit.pay_method}}" selected hidden>{{credit.pay_method}}</option>
                                                    <option value="Cash">Cash</option>
                                                    <option value="Cheque">Cheque</option>
                                                    <option value="UPI">UPI</option>
                                                    {% for b in bank %}
                                                        <option value="{{b.id}}">{{b.bank_name}} (...{{ b.last_four_digits }})</option>
                                                    {% endfor %}
                                                </select>
                                            {% endif %}
                                        </div>
                                        
                                    </div>
                                    <div class="row" >
                                        {% if credit.cheque_no %}
                                            <div class="col-md-4" id="chequediv">
                                                <label class="col-form-label" >Cheque ID</label>
                                                <input type="text" class="form-control border-secondary" name="cheque_id" id="cheque_id" placeholder="Enter Cheque ID" value="{{credit.cheque_no}}" style="color: black;background-color: white;">
                                            </div>
                                        {% else %}
                                            <div class="col-md-4" style="display:none;"  id="chequediv">
                                                <label class="col-form-label" >Cheque ID</label>
                                                <input type="text" class="form-control border-secondary" name="cheque_id" id="cheque_id" placeholder="Enter Cheque ID" style="color: black;background-color: white;">
                                            </div>
                                        {% endif %}
                                        {% if credit.upi_no %}
                                            <div class="col-md-4" id="upidiv">
                                                <label class="col-form-label" >UPI ID</label>
                                                <input type="text" class="form-control border-secondary" name="upi_id" id="upi_id" placeholder="Enter UPI ID" value="{{credit.upi_no}}" style="color: black;background-color: white;">
                                            </div>
                                        {% else %}
                                            <div class="col-md-4"  style="display:none;" id="upidiv">
                                                <label class="col-form-label" >UPI ID</label>
                                                <input type="text" class="form-control border-secondary" name="upi_id" id="upi_id" placeholder="Enter UPI ID" style="color: black;background-color: white;">
                                            </div>
                                        {% endif %}
                                        {% if credit.pay_method != 'Cash' and credit.pay_method != 'Cheque' and credit.pay_method != 'UPI' %}
                                            <div class="col-md-4" id="bnkdiv" >
                                                <label class="col-form-label" >Bank Account</label>
                                                <input type="text" class="form-control border-secondary" name="bnk_id" id="bnk_id" value="{{bankno.account_num}}" style="color: black;background-color: white;" readonly>
                                            </div>
                                        {% else %}
                                            <div class="col-md-4" style="display:none;" id="bnkdiv">
                                                <label class="col-form-label" >Bank Account</label>
                                                <input type="text" class="form-control border-secondary" name="bnk_id" id="bnk_id" style="color: black;background-color: white;" readonly>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                

                                    <!-- .............................................  TABLE 1  ..................................................... -->


                                    <div class="row " style="margin-top: 3rem;">
                                        <div class="col-md-12 table-responsive-md ">
                                            <table class="table table-bordered table-hover text-dark" id="tab_logic">
                                                <thead>
                                                    <tr>
                                                        <th class="text-center">#</th>
                                                        <th class="text-center">PRODUCT</th>
                                                        <th class="text-center">HSN</th>
                                                        <th class="text-center">QTY</th>
                                                        <th class="text-center">PRICE</th>
                                                        <th class="text-center">TAX (%)</th>
                                                        <th class="text-center">DISCOUNT</th>
                                                        <th class="text-center">TOTAL</th>
                                                        <th class="text-center">FIELD</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="items-table-body">
                                                    {% for i in  credititm %}
                                                    <tr id='addr0{{forloop.counter}}'>
                                                        <td style="text-align: center; " class="nnum">
                                                            {{ forloop.counter }}<input type="text" name='id[]'
                                                                value="{{ forloop.counter }}" hidden>
                                                        </td>

                                                        <td class="w-25">
                                                            <div class="d-flex">
                                                                <select name='product[]' id="product{{forloop.counter}}"
                                                                    class="form-control border-secondary product"
                                                                    onchange="changeprd(this.id,this.value); checkItem(this)"
                                                                    style="color: black; background-color: white;">

                                                                    <option value="{{i.product.id}}" selected hidden>
                                                                        {{i.product.item_name}}</option>
                                                                    {% for i in product %}
                                                                    <option value="{{i.id}}">{{ i.item_name }} </option>
                                                                    {% endfor %}
                                                                </select> &nbsp;&nbsp;&nbsp;
                                                                <button type="button" class="btn  btn-outline-info"
                                                                    id="modal_closing" data-bs-toggle="modal"
                                                                    data-bs-target="#newitem" data-bs-whatever="@mdo"
                                                                    style="height: 5vh;"><i class="fa-solid  fa fa-plus rounded"></i></button>
                                                            </div>
                                                        </td>

                                                        <td style="width:12%">
                                                            <input type="text" name='hsn[]'  value="{{ i.product.item_hsn }}" id="hsn{{forloop.counter}}" class="form-control border-secondary" style="color: black; background-color: white;"/>
                                                        </td>

                                                        <td>
                                                            <input type="number" name='qty[]'
                                                                id="qty{{forloop.counter}}" value="{{i.qty}}"
                                                                class="form-control border-secondary qty mb-1" step=0
                                                                min=0 style="color: black; background-color: white; "
                                                                value=0 onchange="checkQuantity(this)" />
                                                        </td>

                                                        <td>
                                                            <input type="number" name='price[]'
                                                                id="unit{{forloop.counter}}"
                                                                value="{{i.product.item_purchase_price}}"
                                                                class="form-control border-secondary price" step="0.00"
                                                                min="0" style="color: black; background-color: white;"
                                                                value=0 readonly />
                                                        </td>

                                                        <td>

                                                            <input type="text" id="intrataxval{{ forloop.counter }}"
                                                                value="{{i.product.item_gst}}" hidden>
                                                            <input type="text" id="intertaxval{{ forloop.counter }}"
                                                                value="{{i.product.item_igst}}" hidden>
                                                            {% if credit.supplyplace == 'State' %}
                                                            <input type="text" name='tax[]'
                                                                id="tax{{ forloop.counter }}"
                                                                class="form-control border-secondary tax"
                                                                style="color: black; background-color: white; "
                                                                value="{{i.product.item_gst}}" readonly />
                                                            {% else %}
                                                            <input type="text" name='tax[]'
                                                                id="tax{{ forloop.counter }}"
                                                                class="form-control border-secondary tax"
                                                                style="color: black; background-color: white; "
                                                                value="{{i.product.item_igst}}" readonly />
                                                            {% endif %}
                                                        </td>

                                                        <td>
                                                            <input type="number" name='discount[]'
                                                                placeholder='Enter Discount'
                                                                id="disc{{forloop.counter}}" value="{{i.discount|default:0}}"
                                                                class="form-control border-secondary disc" step=0 min=0
                                                                style="  color: black; background-color: white;" />
                                                        </td>

                                                        <td>
                                                            <input type="number" name='total[]'
                                                                id="total{{forloop.counter}}"
                                                                class="form-control border-secondary total"
                                                                value='{{i.total}}' readonly
                                                                style="color: black; background-color: white; " />
                                                        </td>
                                                        <td hidden><input type="number" name='taxamount1'
                                                                id="taxamount{{forloop.counter}}" class="taxamount" />
                                                        </td>

                                                        <td>

                                                            <button type="button" id="{{forloop.counter}}"
                                                                class="btn btn-transparent btn-outline-danger px-2 mx-1 py-1 remove_row"><i class="fas fa-trash"></i></button>
                                                        </td>
                                                    </tr>
                                                    {% endfor %}
                                                </tbody>
                                            </table>
                                            <tr>
                                                <td style="border: none;"><a class="btn btn-outline-info ml-1"
                                                        role="button" id="add"><span class="fa fa-plus"></span></a></td>
                                            </tr>
                                        </div>
                                    </div>

                                    <div class="clearfix" style="margin-top:10px">
                                        <div class="row ">
                                            {% comment %} <div class="col-sm-5 d-flex flex-column mt-2">

                                                <label for="">Description</label>
                                                <textarea class="form-control bg-light" name="description" id=""
                                                    cols="8" rows="8"
                                                    placeholder=" ">{{credit.description}}</textarea>
                                            </div> {% endcomment %}
                                            <div class="col-sm-5 " id="tab_logic_total"
                                                style=" color: black; border: 1px solid rgba(128, 128, 128, 0.6); margin-left: 2vh; background-color: rgba(0, 195, 255, 0.205); ; ">

                                                <div class="p-3">
                                                    <div class="row container-fluid p-2 m-0">
                                                        <div class="col-sm-4 mt-2"><label class="text-center">Sub
                                                                Total</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" step="any" name='subtotal'
                                                                value="{{credit.subtotal}}" readonly
                                                                style="color: black; background-color: white;"
                                                                class="form-control border-secondary" id="sub_total">
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>


                                                    {% if credit.supplyplace == 'State' %}
                                                    <div class="row container-fluid p-2 m-0" id="cgstdiv">
                                                        <div class="col-sm-4 mt-2"><label for="a"
                                                                class="text-center">CGST</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" name='cgst' step="any" id="cgst"
                                                                value="{{credit.cgst}}"
                                                                style="color: black; background-color: white;" readonly
                                                                class="form-control" />
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>
                                                    <div class="row container-fluid p-2 m-0" id="sgstdiv">
                                                        <div class="col-sm-4 mt-2"><label for="a"
                                                                class="text-center">SGST</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" name='sgst' step="any" id="sgst"
                                                                value="{{credit.sgst}}"
                                                                style="color: black; background-color: white;" readonly
                                                                class="form-control" />
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>
                                                    <div class="row container-fluid p-2 m-0" style="display: none;"
                                                        id="igstdiv">
                                                        <div class="col-sm-4 mt-2"><label for="a"
                                                                class="text-center">IGST</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" name='igst' step="any" id="igst"
                                                                value="{{credit.igst}}"
                                                                style="color: black; background-color: white;" readonly
                                                                class="form-control" />
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>
                                                    {%endif%}
                                                    {% if credit.supplyplace == 'Other State' %}
                                                    <div class="row container-fluid p-2 m-0" style="display: none;"
                                                        id="cgstdiv">
                                                        <div class="col-sm-4 mt-2"><label for="a"
                                                                class="text-center">CGST</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" name='cgst' step="any" id="cgst"
                                                                value="{{credit.cgst}}"
                                                                style="color: black; background-color: white;" readonly
                                                                class="form-control" />
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>
                                                    <div class="row container-fluid p-2 m-0" style="display: none;"
                                                        id="sgstdiv">
                                                        <div class="col-sm-4 mt-2"><label for="a"
                                                                class="text-center">SGST</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" name='sgst' step="any" id="sgst"
                                                                value="{{credit.sgst}}"
                                                                style="color: black; background-color: white;" readonly
                                                                class="form-control" />
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>
                                                    <div class="row container-fluid p-2 m-0" id="igstdiv">
                                                        <div class="col-sm-4 mt-2"><label for="a"
                                                                class="text-center">IGST</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" name='igst' step="any" id="igst"
                                                                value="{{credit.igst}}"
                                                                style="color: black; background-color: white;" readonly
                                                                class="form-control" />
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>
                                                    {% endif %}

                                                    <div class="row container-fluid p-2 m-0">
                                                        <div class="col-sm-4 mt-2"><label for="a"
                                                                class="text-center">Tax Amount</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" step="any" name='taxamount'
                                                                id="tax_amount" value="{{credit.taxamount}}"
                                                                readonly style="color: black; background-color: white;"
                                                                class="form-control border-secondary" />
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>

                                                    <div class="row container-fluid p-2 m-0">
                                                        <div class="col-sm-4 mt-2"><label for="a"
                                                                class="text-center">Adjustment</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" step="any" name='adj' id="adj"
                                                                value="{{credit.adjust}}"
                                                                class="form-control border-secondary"
                                                                style="color: black; background-color: white;" />
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>

                                                    <div class="row container-fluid p-2 m-0">
                                                        <div class="col-sm-4 mt-2"><label for="a"
                                                                class="text-center">Grand Total</label></div>
                                                        <div class="col-sm-1 mt-2">:</div>
                                                        <div class="col-sm-7">
                                                            <input type="number" name='grandtotal' id="grandtotal"
                                                                value="{{credit.grandtotal}}" readonly
                                                                style="color: black; background-color: white;"
                                                                class="form-control border-secondary" />
                                                        </div>
                                                        <div class="col-sm-4 m-0 p-0"></div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row ">
                                            <div class="col-sm-5 mt-4" id="tab_logic_total"
                                                style="color: black; border: 1px solid rgba(128, 128, 128, 0.6);margin-left:10px; background-color:rgba(0, 195, 255, 0.205); ">
                                                <div class="row container-fluid p-2 m-0">
                                                    <div class="col-sm-4 mt-2"><label for="a" class="text-center">Paid
                                                            Off</label></div>
                                                    <div class="col-sm-1 mt-2">:</div>
                                                    <div class="col-sm-7">
                                                        <input type="number" step="any" name='advance' id="advance"
                                                            value="{{credit.advance}}"
                                                            class="form-control border-secondary"
                                                            style="color: black; background-color: white;" />
                                                    </div>
                                                    <div class="col-sm-4 m-0 p-0"></div>
                                                </div>
                                                <div class="row container-fluid p-2 m-0">
                                                    <div class="col-sm-4 mt-2"><label for="a"
                                                            class="text-center">Balance</label></div>
                                                    <div class="col-sm-1 mt-2">:</div>
                                                    <div class="col-sm-7">
                                                        <input type="number" name='balance' id="balance"
                                                            value="{{credit.balance}}" readonly
                                                            style="color: black; background-color: white;"
                                                            class="form-control border-secondary" readonly />
                                                    </div>
                                                    <div class="col-sm-4 m-0 p-0"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="row py-5 border-bottom bg-light" style="margin-left:10px;">
                                    <div class="col-md-8 d-flex flex-column w-60 text-dark">
                                        <label for="">Description</label>
                                        <textarea name="description" id="" cols="20" rows="3" class="form-control"
                                            placeholder="Add any Description" style="width:90%;"></textarea>
                                    </div>
                                </div>
                                
                                <div class="col-md-5 mt-4">
                                    <input type="submit" class="btn btn-primary save-button" name="save" value="Save">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- party modal start -->


    <div class="modal fade" id="customercreation">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background-color: rgba(144, 211, 117, 0.098);">
                    <h3 class="m-3 text-secondary">ADD PARTY</h3>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background-color: rgba(144, 211, 117, 0.098);">
                    <form method="POST" action="{% url 'salesinvoice_save_parties' %}" class="p-5"
                        enctype="multipart/form-data" novalidate id="partyforms">
                        {% csrf_token %}
                        <div class="bg-light bs p-4 rounded mb-5">
                            <div id="main_form_div">
                                <div class="row" style="margin-left: -1vh;">
                                    <div class="col-md-4">
                                        <label class="col-form-label" for="partyname" style="color: black;">Party
                                            Name</label>
                                        <input type="text" class="form-control border-secondary" id="partyname"
                                            name="partyname" style="color: black;" required>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="col-form-label" style="color: black;">GSTIN</label>
                                        <input type="text" class="form-control border-secondary"
                                            onchange="checkgst(this)" id="gstin" name="gstin" style="color: black;"
                                            placeholder="29APPCK7465F1Z1">
                                        <div class="text-danger m-2" id="warngst"></div>
                                        <span id="gstError" class="text-danger"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <label class="col-form-label" for="partyphno"
                                            style="color: black;">Mobile</label>
                                        <input type="number" class="form-control border-secondary" id="partyphno"
                                            name="partyphno" style="color: black;" onchange="checkphone(this)" required>
                                        <div class="text-danger m-2" id="warnphone"></div>
                                        <span id="phnError" class="text-danger"></span>
                                    </div>
                                </div>

                                <div>
                                    <p></p>
                                    <hr class="p-0 m-0">
                                    <div style="background-color: rgba(0, 195, 255, 0.205);" class="p-3 pb-0 mb-0">
                                        <div class="">
                                            <div class="row pb-0 mb-0">
                                                <div id="gsthead" class="col text-center pb-2">
                                                    <a class="fw-bolder fs-4" style="color: gray; cursor: pointer;">GST
                                                        & ADDRESS</a>
                                                </div>
                                                <div id="credithead" class="col text-center pb-2">
                                                    <a class="fw-bolder fs-4"
                                                        style="color: gray; cursor: pointer;">CREDIT & BALANCES</a>
                                                </div>
                                                <div id="fieldhead" class="col text-center pb-2">
                                                    <a class="fw-bolder fs-4"
                                                        style="color: gray; cursor: pointer;">ADDITIONAL FIELD</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="gsttemp" style="background-color: rgba(144, 211, 117, 0.098);">
                                        <div class="row">
                                            <div class="col-sm-12  col-md-1"></div>
                                            <div class="col-sm-12 col-md-10 pb-4">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="col-form-label mt-4" style="color: black;">GST
                                                            Type</label>
                                                        <select class="form-control border-secondary" id="modalgsttype"
                                                            name="modalgsttype"
                                                            style="color: black; background-color: white;">
                                                            <option selected value="" hidden>Select</option>
                                                            <option value="Registered Party">Registered Party</option>
                                                            <option value="Unregistered or Consumer">Unregistered or
                                                                Consumer</option>
                                                            <option value="Registered Business or Combosision">
                                                                Registered Business or Combosision</option>
                                                        </select>

                                                        <label class="col-form-label mt-4" for="company"
                                                            style="color: black;">Supply State</label>
                                                        <select class="form-control border-secondary" name="splystate"
                                                            id="splystate"
                                                            style="color: black; background-color: white;">
                                                            <option value="" selected hidden>Select</option>
                                                            <option value="Andaman and Nicobar Islads">Andaman and
                                                                Nicobar Islands</option>
                                                            <option value="Andhra Pradhesh">Andhra Pradhesh</option>
                                                            <option value="Arunachal Pradesh">Arunachal Pradesh</option>
                                                            <option value="Assam">Assam</option>
                                                            <option value="Bihar">Bihar</option>
                                                            <option value="Chandigarh">Chandigarh</option>
                                                            <option value="Chhattisgarh">Chhattisgarh</option>
                                                            <option value="Dadra and Nagar Haveli">Dadra and Nagar
                                                                Haveli</option>
                                                            <option value="Daman anad Diu">Daman anad Diu</option>
                                                            <option value="Delhi">Delhi</option>
                                                            <option value="Goa">Goa</option>
                                                            <option value="Gujarat">Gujarat</option>
                                                            <option value="Haryana">Haryana</option>
                                                            <option value="Himachal Pradesh">Himachal Pradesh</option>
                                                            <option value="Jammu and Kashmir">Jammu and Kashmir</option>
                                                            <option value="Jharkhand">Jharkhand</option>
                                                            <option value="Karnataka">Karnataka</option>
                                                            <option value="Kerala">Kerala</option>
                                                            <option value="Ladakh">Ladakh</option>
                                                            <option value="Lakshadweep">Lakshadweep</option>
                                                            <option value="Madhya Pradesh">Madhya Pradesh</option>
                                                            <option value="Maharashtra">Maharashtra</option>
                                                            <option value="Manipur">Manipur</option>
                                                            <option value="Meghalaya">Meghalaya</option>
                                                            <option value="Mizoram">Mizoram</option>
                                                            <option value="Nagaland">Nagaland</option>
                                                            <option value="Odisha">Odisha</option>
                                                            <option value="Pondicherry">Pondicherry</option>
                                                            <option value="Punjab">Punjab</option>
                                                            <option value="Rajasthan">Rajasthan</option>
                                                            <option value="Sikkim">Sikkim</option>
                                                            <option value="Tamil Nadu">Tamil Nadu</option>
                                                            <option value="Telangana">Telangana</option>
                                                            <option value="Tripura">Tripura</option>
                                                            <option value="Uttar Pradesh">Uttar Pradesh</option>
                                                            <option value="Uttarakhand">Uttarakhand</option>
                                                            <option value="West Bengal">West Bengal</option>
                                                            <option value="Other Territory">Other Territory</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="col-form-label mt-4" style="color: black;">Billing
                                                            Address</label>
                                                        <textarea class="form-control border-secondary" name="baddress"
                                                            id="baddress" rows="6" type="text"
                                                            style="color: black; background-color: white;"></textarea>
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="col-form-label mt-4" for="partyemail"
                                                            style="color: black;">Email</label>
                                                        <input type="email" class="form-control border-secondary"
                                                            id="partyemail" name="partyemail"
                                                            style="color: black; background-color: white;" required>
                                                            <div id="emailError" style="color: red;"></div>
                                                    </div>
                                                </div>

                                                <div class="text-start mt-5">
                                                    <button id="gstnxt" class="btn btn-primary bg-gradient"
                                                        type="button">NEXT</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="credittemp" style="background-color: rgba(144, 211, 117, 0.098);" hidden>
                                        <div class="row">
                                            <div class="col-sm-12  col-md-1"></div>
                                            <div class="col-sm-12 col-md-10 pb-4">
                                                <div class="row mt-4">
                                                    <div class="col-md-6">
                                                        <label class="col-form-label" style="color: black;"
                                                            for="openbalance">Opening Balance &nbsp; &nbsp; - </label>
                                                        &nbsp;&nbsp;&nbsp;
                                                        <label class="col-form-label" style="color: black;">To
                                                            Pay</label> &nbsp; &nbsp;
                                                        <input type="radio" class="radio-input border-secondary"
                                                            id="toPayRadio" name="paymentType" value="To Pay"> &nbsp;
                                                        &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                                                        <label class="col-form-label" style="color: black;">To
                                                            Receive</label> &nbsp; &nbsp;
                                                        <input type="radio" class="radio-input border-secondary"
                                                            id="toReceiveRadio" name="paymentType" value="To Receive">
                                                        <input type="number" class="form-control border-secondary"
                                                            id="openbalance" name="openbalance"
                                                            style="color: black; background-color: white;" value="0">
                                                    </div>
                                                    <div class="col-md-6">
                                                        <label class="col-form-label" style="color: black;"
                                                            for="openbalance">Credit Limit</label>
                                                        <input type="number" class="form-control border-secondary"
                                                            id="crd_lmt" name="crd_lmt"
                                                            style="color: black; background-color: white;" value="0">
                                                    </div>
                                                </div>

                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label class="col-form-label mt-4"
                                                            style="color: black;">Date</label>
                                                        <input type="date" class="form-control border-secondary"
                                                            id="partydate" name="partydate"
                                                            style="color: black; background-color: white;"
                                                            value="{{todate}}">
                                                    </div>
                                                </div>

                                                <div class="text-start mt-5">
                                                    <button id="creditprev" class="btn btn-primary bg-gradient"
                                                        type="button">PREVIOUS</button>
                                                    <button id="creditnxt" class="btn btn-primary bg-gradient me-3"
                                                        type="button">NEXT</button>

                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="fieldtemp" style="background-color: rgba(144, 211, 117, 0.098);" hidden>
                                        <div class="row">
                                            <div class="col-sm-12  col-md-1"></div>
                                            <div class="col-sm-12 col-md-10 pb-4">
                                                <div class="row mt-4">
                                                    <div class="col-md-4">
                                                        <label class="col-form-label" style="color: black;">Additional
                                                            Field 1</label>
                                                        <input type="text" class="form-control border-secondary"
                                                            id="additional1" name="additional1"
                                                            style="color: black; background-color: white;">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="col-form-label" style="color: black;">Additional
                                                            Field 2</label>
                                                        <input type="text" class="form-control border-secondary"
                                                            id="additional2" name="additional2"
                                                            style="color: black; background-color: white;">
                                                    </div>
                                                    <div class="col-md-4">
                                                        <label class="col-form-label" style="color: black;">Additional
                                                            Field 3</label>
                                                        <input type="text" class="form-control border-secondary"
                                                            id="additional3" name="additional3"
                                                            style="color: black; background-color: white;">
                                                    </div>
                                                </div>
                                                <div class="text-start mt-5">
                                                    <button id="fieldprev" class="btn btn-primary bg-gradient  me-3"
                                                        type="button">PREVIOUS</button>
                                                    <input type="submit" class="btn btn-primary bg-gradient "
                                                        name="save" value="Save">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- modal end -->

    <script>
        $(document).ready(function () {
            $('#partyforms').submit(function (event) {
                event.preventDefault(); // Prevent the default form submission

                var formData = $(this).serialize(); // Serialize the form data

                $.ajax({
                    url: $(this).attr('action'),
                    type: $(this).attr('method'),
                    data: formData,
                    dataType: 'json',
                    success: function (response) {
                        $('#customercreation').modal('hide');
                        updatePartyDropdown(); // Call updatePartyDropdown after successful form submission
                        if (response.status === false) {
                            $("#error_message").text(response.message);
                            alert(response.message);
                        } else {
                            alert("Party added successfully.");
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(xhr.responseText);
                        alert("An error occurred. Please try again later."); // Show a generic error message for unexpected errors
                    }
                });
            });
        });
    </script>

    <!-- modal -->
    <div class="modal fade" id="newitem">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background-color: rgba(144, 211, 117, 0.098);">
                    <h3 class="text-secondary ms-3">ADD ITEM</h3>
                    <button type="button" class="btn-close me-3" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" style="background-color: rgba(144, 211, 117, 0.098);">
                    <form method="post" class="needs-validation" novalidate autocomplete="off" id="modalItem">
                        {% csrf_token %}
                        <div class="bg-light bs p-4 rounded mb-5">
                            <div id="main_form_div">
                                <div class="row" style="margin-left: -1vh;">
                                    <div class="col-md-3">
                                        <select style="color: black;" class="form-control border-dark bg-light"
                                            name="type" id="type" required>
                                            <option selected value="" hidden>Select Type</option>
                                            <option value="Goods">Products</option>
                                            <option value="Services">Services</option>
                                        </select>
                                    </div>
                                    <div class="col-md-3">
                                        <input style="color: black;" class="form-control border-dark fw-bolder"
                                            type="text" placeholder="ITEM NAME" autocomplete="off" id="item_name"
                                            name="item_name" required>
                                    </div>
                                    <div class="col-md-3">
                                        <input style="color: black;" class="form-control border-dark fw-bolder"
                                            type="number" placeholder="ITEM HSN" id="hsn" name="hsn"
                                            onchange="checkhsn(this)" required>
                                        <div class="text-danger m-2" id="warnhsn"></div>
                                    </div>
                                    <div class="col-md-2">
                                        <select style="color: black;" class="form-control border-dark bg-light"
                                            id="unit" name="unit" required>
                                            <option value="" hidden>Select a unit</option>
                                            <option value="NOS">NOS</option>
                                            <option value="BOX">BOX</option>
                                            <option value="PACKET">PACKET</option>
                                            {% for i in item_units %}
                                            <option value="{{ i.unit_name|upper }}">{{ i.unit_name|upper }}</option>
                                            {% endfor %}
                                        </select>
                                        <div class="row"
                                            style="margin-top:-40px;height:30px;width:50px;margin-left:160px;">
                                            <button id="modal_closing_btn" type="button" style="margin-right:5px;"
                                                class="btn bg-warning" onclick="openUnitModal()"><span
                                                    class="fa fa-plus"></span></button>
                                        </div>
                                    </div>
                                    <div id="unitModal" class="unit-modal">
                                        <div class="unit-modal-content">
                                            <span class="close-btn" onclick="closeUnitModal()">&times;</span>
                                            <h1 class="modal-title fs-5">ADD UNIT</h1>
                                            <form class="mb-0" id="unit_form">
                                                {% csrf_token %}
                                                <div class="mb-3">
                                                    <label for="item_unit_name_id" class="col-form-label">UNIT</label>
                                                    <input type="text" class="form-control border-dark text-uppercase"
                                                        id="item_unit_name_id" placeholder="ENTER UNIT HERE.."
                                                        name="item_unit_name" required>
                                                </div>
                                                <div class="m-0 text-center">
                                                    <label for="message-text"
                                                        class="col-form-label  text-secondary fw-lighter">Example:
                                                        PCS/BOX/LITER</label>
                                                </div>
                                                <input hidden id="submit_unit_creation" type="submit">
                                            </form>
                                            <div class="modal-footer d-flex justify-content-center mt-1">
                                                <button id="modal_cls_btn" type="button"
                                                    class="btn btn-secondary ps-5 pe-5"
                                                    onclick="closeUnitModal()">Close</button>
                                                <button id="add_btn_" type="button" class="btn btn-primary ps-5 pe-5"
                                                    onclick="submit_unit_creation_fn()">ADD</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <div>
                                <p></p>
                                <hr class="p-0 m-0">
                                <div style="background-color: rgba(0, 195, 255, 0.205);" class="p-3 pb-0 mb-0">
                                    <div class="">
                                        <div class="row pb-0 mb-0">
                                            <div id="prc_" class="col text-center pb-2">
                                                <a class="fw-bolder fs-4"
                                                    style="color: gray; cursor: pointer;">PRICING</a>
                                            </div>
                                            <div id="stk_" class="col text-center pb-2">
                                                <a class="fw-bolder fs-4"
                                                    style="color: gray; cursor: pointer;">STOCKS</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="pricing_template" style="background-color: rgba(144, 211, 117, 0.098);">
                                    <div class="row">
                                        <div class="col-sm-12  col-md-1"></div>
                                        <div class="col-sm-12 col-md-10 pb-4">
                                            <div class="text- pt-5">
                                                <label class="fs-4 tb" for="item_tax_1"
                                                    style=" user-select: none; color: black;">Taxable</label>
                                                <input class="me-3" name="taxref" type="radio" id="inclusive"
                                                    value="Taxable" required>
                                                <label class="fs-4 tb" for="item_tax_2"
                                                    style=" user-select: none; color: black;">Non Taxable</label>
                                                <input name="taxref" type="radio" value="Non Taxable" id="check"
                                                    required>
                                            </div>
                                            <br>
                                            <div id="taxdiv" style="display: none;">
                                                <div class="d-flex">
                                                    <div class="w-50 me-3">
                                                        <label class="fw-bold tb fs-3" for=""
                                                            style="color: black;">GST</label><br>
                                                        <select style="color: black;background-color: white;"
                                                            class="form-control fw- border-secondary fs-3" id="intra_st"
                                                            name="intra_st">
                                                            <option value="GST0[0%]" selected>GST0[0%]</option>
                                                            <option value="GST3[3%]">GST3[3%]</option>
                                                            <option value="GST5[5%]">GST5[5%]</option>
                                                            <option value="GST12[12%]">GST12[12%]</option>
                                                            <option value="GST18[18%]">GST18[18%]</option>
                                                            <option value="GST28[28%]">GST28[28%]</option>
                                                        </select>
                                                    </div>
                                                    <div class="w-50">
                                                        <label class="fw-bold tb fs-3" for=""
                                                            style="color: black;">IGST</label><br>
                                                        <select style="color: black;background-color: white;"
                                                            class="form-control fw- border-secondary tb fs-3"
                                                            id="inter_st" name="inter_st">
                                                            <option value="IGST0[0%]" selected>IGST0[0%]</option>
                                                            <option value="IGST3[3%]">IGST3[3%]</option>
                                                            <option value="IGST5[5%]">IGST5[5%]</option>
                                                            <option value="IGST12[12%]">IGST12[12%]</option>
                                                            <option value="IGST18[18%]">IGST18[18%]</option>
                                                            <option value="IGST28[28%]">IGST28[28%]</option>
                                                        </select>
                                                    </div>
                                                </div>
                                                <br>
                                            </div>

                                            <div class="d-flex">
                                                <div class="w-50 me-3">
                                                    <label class="tb fw-bold" for="" style="color: black;">SALES
                                                        PRICE</label><br>
                                                    <input style="color: black;background-color: white;" id="saleprice"
                                                        class="form-control fw-normal border-secondary  fs-3"
                                                        type="number" name="saleprice" value="0">
                                                </div>
                                                <div class="w-50">
                                                    <label class="tb fw-bold" for="" style="color: black;">PURCHASE
                                                        PRICE</label><br>
                                                    <input style="color: black;background-color: white;" id="purprice"
                                                        class="form-control fw-normal border-secondary  fs-3"
                                                        type="number" name="purprice" value="0">
                                                </div>
                                            </div>
                                            <div class="text-start mt-5">
                                                <button id="next_btn" class="btn btn-primary bg-gradient"
                                                    type="button">Next</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div hidden id="stock_template" style="background-color: rgba(144, 211, 117, 0.098);">
                                    <div class="row">
                                        <div class="col-sm-12  col-md-1"></div>
                                        <div class="col-sm-12 col-md-10 pb-4">
                                            <br><br>
                                            <div class="d-flex">
                                                <div class="w-50 me-3">
                                                    <label class="tb fw-bold" for="stock" style="color: black;">OPENING
                                                        STOCK</label><br>
                                                    <input style="color: black;background-color: white;" id="stock"
                                                        class="form-control fw-normal border-secondary  fs-3"
                                                        type="number" name="stock" value="0">
                                                </div>
                                                <div id="at_price_div" class="w-50">
                                                    <label class="tb fw-bold" for="itmprice" style="color: black;">AT
                                                        PRICE</label><br>
                                                    <input style="color: black;background-color: white" id="itmprice"
                                                        class="form-control fw-normal border-secondary  fs-3"
                                                        type="number" name="itmprice" value="0">
                                                </div>
                                            </div>
                                            <br>
                                            <div class="d-flex">
                                                <div class="w-50 me-3">
                                                    <label class="tb fw-bold" for="itmdate"
                                                        style="color: black;">DATE</label><br>
                                                    <input style="color: black;background-color: white" id="itmdate"
                                                        class="form-control fw-normal border-secondary  fs-3"
                                                        type="date" required name="itmdate" value="{{todate}}">
                                                </div>
                                                <div class="w-50">
                                                    <label class="tb fw-bold" for="minstock"
                                                        style="color: black;">MINIMUM STOCK TO MAINTAIN</label><br>
                                                    <input style="color: black;background-color: white" id="minstock"
                                                        class="form-control fw-normal border-secondary  fs-3"
                                                        type="number" name="minstock" value="0">
                                                </div>
                                            </div>
                                            <div class="text-start mt-5">
                                                <button id="prev_btn" class="btn btn-primary bg-gradient  me-3"
                                                    type="button">PREVIOUS</button>
                                                <button class="btn btn-primary bg-gradient" type="button"
                                                    id="itemsave">SAVE</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- item modal end -->

</body>



<script>
    function submit_unit_creation_fn() {
        var unitName = $("#item_unit_name_id").val();
        $.ajax({
            type: 'POST',
            url: "{% url 'item_unit_create_salesinvoice' %}",
            data: {
                item_unit_name: unitName,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (response) {
                console.log(response);
                if (response.message) {
                    alert(response.message);
                    updateUnitDropdown(response.unit_name);
                    $("#item_unit_name_id").val('')
                    closeUnitModal()
                } else {
                    alert('Unit not saved. Please try again.');
                }
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
                alert('Error: ' + xhr.responseText);
            }
        });
    }

   
    function updateUnitDropdown(unitName) {
        $("#unit").append('<option value="' + unitName + '">' + unitName + '</option>');
    }
</script>
<script>
    function openUnitModal() {
        document.getElementById('unitModal').style.display = 'block';
    }

    function closeUnitModal() {
        document.getElementById('unitModal').style.display = 'none';
    }
</script>



<script>
    $('#partySelect').change(function () {
        getprty();
      
    });
</script>

<script>
    
    document.addEventListener("DOMContentLoaded", function () {
        getprty();
       
    });



    function updatePartyDropdown() {
        $.ajax({
            url: "{% url 'get_party_list' %}",
            type: "GET",
            dataType: "json",
            success: function(data) {
                var $select = $('#partySelect')[0].selectize;
                var existingOptions = $select.options;
                $select.clearOptions(); 
                $.each(existingOptions, function(value, option) {
                    $select.addOption(option); 
                });
                $.each(data, function(key, value) {
                    if (!existingOptions[value[0]]) {
                        $select.addOption({ value: value[0], text: value[1] });
                    }
                });
                $select.refreshOptions(false); 
            },
            error: function(xhr, status, error) {
                console.error("Error fetching party list:", error);
            }
        });
    }

    $(document).ready(function() {
        $('#partySelect').selectize({
            openOnFocus: false, 
            onDropdownOpen: function($dropdown) {
                updatePartyDropdown(); 
            }
        });
    });
</script>



</script>



<script>
    function getprty() {
        var party_id = $('#partySelect').val();
        console.log(party_id);
        $.ajax({
            type: "GET",
            url: "{% url 'getparty_salesinvoice' %}",
            data: {
                id: party_id
            },
            success: function (data) {
                console.log(data);
                if (data.error) {
                    console.error(data.error);
                    return;
                }
                $('#partyPhone').val(data.phone);
                $('#partyAddress').val(data.address);

                var openingBalanceElement = $('#partyBalance');
                openingBalanceElement.html('Balance Amount: <span class="amount">' + data.balance + '</span>');
                var openingBalanceAmountElement = openingBalanceElement.find('.amount');

                var paymentStatus = data.payment;

                if (paymentStatus === 'To Pay') {
                    openingBalanceAmountElement.css('color', 'red');
                } else if (paymentStatus === 'To Receive') {
                    openingBalanceAmountElement.css('color', 'green');
                } else {
                    openingBalanceAmountElement.css('color', 'black');
                }
            },
            error: function (xhr, status, error) {
                console.error("Error:", error);
            }
        });
    }
</script>



<script>
    $(document).ready(function () {
        $('#bank').on('change', function () {
        
            $('#chequeNumberBox, #upiNumberBox, #bankAccountBox').hide();

            var selectedOption = $(this).val();
            if (selectedOption === 'Cheque') {
                $('#chequeNumberBox').show();
            } else if (selectedOption === 'UPI') {
                $('#upiNumberBox').show();
            } else if (selectedOption !== 'Cash' && selectedOption !== '') {
              
                $('#bankAccountBox').show();
            }
        });

       
        $('#bank').change();
    });


    $(document).ready(function() {
        $("#pay_method").change(function() {
            var x=$('#pay_method').val();
            console.log(x);
            if(x==='Cash'){
                $('#chequediv').hide()
                $('#bnkdiv').hide()
                $('#upidiv').hide()
                document.getElementById('cheque_id').value=null
                document.getElementById('upi_id').value=null
                document.getElementById('bnk_id').value=null
            } else if(x==='Cheque') {
                $('#chequediv').show()
                $('#bnkdiv').hide()
                $('#upidiv').hide()
                document.getElementById('upi_id').value=null
                document.getElementById('bnk_id').value=null
            } else if(x==='UPI') {
                $('#upidiv').show()
                $('#bnkdiv').hide()
                $('#chequediv').hide()
                document.getElementById('cheque_id').value=null
                document.getElementById('bnk_id').value=null
            } else {
                $('#bnkdiv').show()
                $('#chequediv').hide()
                $('#upidiv').hide()
                document.getElementById('cheque_id').value=null
                document.getElementById('upi_id').value=null

                $.ajax({
                    type: "POST",
                    url: "{% url 'credit_bankdetails' %}",
                    data: {
                        id: x,
                        csrfmiddlewaretoken: '{{ csrf_token }}'
                    },
                    success: function (response) {
                        document.getElementById('cheque_id').value=null
                        document.getElementById('upi_id').value=null
                        document.getElementById('bnk_id').value = response.bank_no;
                    }
                });
            }
        });
    });

   

    function formatDate(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        return `${year}-${month}-${day}`;
    }


    const currentDateInput = document.getElementById("current-date");
    const currentDate = new Date();
    currentDateInput.value = formatDate(currentDate);


    function updateBankDetails() {
        var selectedbank = encodeURIComponent(document.getElementById('bank').value);
        var endpoint = '/api/bank-details/' + selectedbank;

        fetch(endpoint)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('accountNumber').value = data.accountNumber;

            })
            .catch(error => console.error('Error fetching party details:', error));
    }

</script>


<script>
    $(document).ready(function () {
        $('#gsthead').css({ 'border-bottom': '3px solid rgba(0, 0, 0, 0.548)' })
        $('#gsthead a').addClass('text-dark')
        $('#gsttemp').attr('hidden', false)
        $('#credithead').css({ 'border-bottom': 'none' })
        $('#credithead a').removeClass('text-dark')
        $('#fieldhead').css({ 'border-bottom': 'none' })
        $('#fieldhead a').removeClass('text-dark')

        $('#gsthead').on('click', function () {
            $(this).css({ 'border-bottom': '3px solid rgba(0, 0, 0, 0.548)' })
            $('#gsthead a').addClass('text-dark')
            $('#gsttemp').attr('hidden', false)
            $('#credithead').css({ 'border-bottom': 'none' })
            $('#credithead a').removeClass('text-dark')
            $('#credittemp').attr('hidden', true)
            $('#fieldhead').css({ 'border-bottom': 'none' })
            $('#fieldtemp a').removeClass('text-dark')
            $('#fieldtemp').attr('hidden', true)
        })

        $('#credithead').on('click', function () {
            $('#credithead').css({ 'border-bottom': '3px solid rgba(0, 0, 0, 0.548)' })
            $('#credithead a').addClass('text-dark')
            $('#credittemp').attr('hidden', false)
            $('#gsthead').css({ 'border-bottom': 'none' })
            $('#gsthead a').removeClass('text-dark')
            $('#gsttemp').attr('hidden', true)
            $('#fieldhead').css({ 'border-bottom': 'none' })
            $('#fieldhead a').removeClass('text-dark')
            $('#fieldtemp').attr('hidden', true)
        })

        $('#fieldhead').on('click', function () {
            $('#fieldhead').css({ 'border-bottom': '3px solid rgba(0, 0, 0, 0.548)' })
            $('#fieldhead a').addClass('text-dark')
            $('#fieldtemp').attr('hidden', false)
            $('#gsthead').css({ 'border-bottom': 'none' })
            $('#gsthead a').removeClass('text-dark')
            $('#gsttemp').attr('hidden', true)
            $('#credithead').css({ 'border-bottom': 'none' })
            $('#credithead a').removeClass('text-dark')
            $('#credittemp').attr('hidden', true)
        })
    })

    $(document).ready(function () {
        $('#gstnxt').on('click', function () {
            $('#credithead').click()
        })

        $('#creditnxt').on('click', function () {
            $('#fieldhead').click()
        })
    })

    $(document).ready(function () {
        $('#fieldprev').on('click', function () {
            $('#credithead').click()
        })
        $('#creditprev').on('click', function () {
            $('#gsthead').click()
        })
    })

    function checkgst(element) {
        var gstinput = element.value;
        var gstregexp = "[0-9]{2}[a-zA-Z]{5}[0-9]{4}[a-zA-Z]{1}[1-9A-Za-z]{1}[Z]{1}[0-9a-zA-Z]{1}";
        if (gstinput.match(gstregexp)) {
            document.getElementById('warngst').innerHTML = '';
        } else {
            document.getElementById('warngst').innerHTML = 'Please provide a valid GST Number';
            alert('Please provide a valid GST Number');
        }
    }

    function checkphone(element) {
        var phoneinput = element.value;
        var phoneregexp = /^[0-9]{10}$/;
        if (phoneinput.match(phoneregexp)) {
            document.getElementById('warnphone').innerHTML = '';
        } else {
            document.getElementById('warnphone').innerHTML = 'Please provide a valid Phone Number';
            alert('Please provide a valid Phone Number')
        }
    }

    function checkhsn(element) {
        var hsninput = element.value;
        var gstregexp = /^[0-9]{6}$/;
        if (hsninput.match(gstregexp)) {
            document.getElementById('warnhsn').innerHTML = '';
        } else {
            document.getElementById('warnhsn').innerHTML = 'Please provide a valid HSN Number';
            alert('Please provide a valid HSN Number');
        }
    }


    $(document).on("click", "#itemsave", function () {
        var item_name = document.getElementById('item_name').value;

        if ($('#inclusive').prop('checked')) {
            tax = $('#inclusive').val();
        }
        else {
            tax = $('#check').val();
        }

        if (item_name === '') {
            alert('Please provide an Item Name');
        } else {
            $.ajax({
                type: 'POST',
                url: "{% url 'item_save_invoice' %}",
                data: {
                    name: $("#item_name").val(),
                    unit: $("#unit").val(),
                    hsn: $("#hsn").val(),
                    taxref: tax,
                    sell_price: $("#saleprice").val(),
                    cost_price: $("#purprice").val(),
                    intra_st: $("#intra_st").val(),
                    inter_st: $("#inter_st").val(),
                    itmdate: $("#itmdate").val(),
                    stock: $("#stock").val(),
                    itmprice: $("#itmprice").val(),
                    minstock: $("#minstock").val(),
                    csrfmiddlewaretoken: '{{ csrf_token }}',
                },

                success: function (response) {
                    if (response.success) {
                        document.getElementById("modalItem").reset();
                        $('#newitem').modal('hide');
                        reloadItem();
                    } else {
                       
                        alert('Error: ' + response.message);
                    }
                },
            });
        }
    });

    function reloadItem() {
        $.ajax({
            url: "{% url 'item_invoicedropdown' %}",
            type: "GET",
            dataType: "json",
            data: $(this).serialize(),
            csrfmiddlewaretoken: '{{ csrf_token }}',

            success: function (data) {
                id_list = data.id_list
                product_list = data.product_list
                var table = document.getElementById('tab_logic');
                var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
                for (var i = 1; i <= rows.length; i++) {
                    var $select = $(document.getElementById('product' + i));
                    var selectize = $select[0].selectize;
                    for (let i = 0; i < id_list.length; i++) {
                        selectize.addOption({ value: id_list[i], text: product_list[i] });
                    }
                }
            },
            error: function (xhr, status, error) {
                console.error(xhr.responseText);
            }
        });

    }


</script>

<script>
    $(document).ready(function () {
        $('.product').selectize({
            sortField: 'value',
            render: {
                item: function (item, escape) {
                    if (item.value === '') {
                        return '';
                    }
                    return '<div>' + escape(item.text) + '</div>';
                }
            }

        });
    });

    function productsearch(roinc) {
        $(`#product${roinc}`).selectize({
            sortField: 'value',
            render: {
                item: function (item, escape) {
                    if (item.value === '') {
                        return '';
                    }
                    return '<div>' + escape(item.text) + '</div>';
                }
            }
        });
    }
</script>
<script>
    var selected_items = [];

    $(document).ready(function() {
        // Initialize selected_items with pre-selected items
        $('select.product').each(function() {
            var selectedValue = $(this).val();
            if (selectedValue) {
                selected_items.push(selectedValue);
            }
        });

        console.log('Initial selected items:', selected_items);
    });

    function changeprd(id, value) {
        var n = id.slice(7);

        console.log('changeprd called with id:', id, 'value:', value);

        if (selected_items.includes(value)) {
            alert('The same item cannot be selected again in another row');
        } else {
            selected_items.push(value);
            console.log('Selected items after push:', selected_items);
            $.ajax({
                url: "{% url 'itemdata_salesinvoiceedit' %}",
                type: 'GET',
                data: {
                    id: value,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success: function(response) {
                    var data = response.hsn;
                    var data2 = response.qty;
                    var data3 = response.price;
                    var data4 = response.gst;
                    var data5 = response.igst;
                    var bc = document.getElementById("stateOfSupply").value;

                    if (bc == 'State') {
                        document.getElementById('intrataxval' + n).value = data4;
                        document.getElementById('intertaxval' + n).value = data5;
                        document.getElementById('hsn' + n).value = data;
                        document.getElementById('unit' + n).value = data3;
                        document.getElementById('tax' + n).value = data4;
                        calc();
                    }
                    if (bc == 'Other State') {
                        document.getElementById('intrataxval' + n).value = data4;
                        document.getElementById('intertaxval' + n).value = data5;
                        document.getElementById('hsn' + n).value = data;
                        document.getElementById('unit' + n).value = data3;
                        document.getElementById('tax' + n).value = data5;
                        calc();
                    }
                },
            });
        }
    }




    $(document).on("change", "#stateOfSupply", function () {

        var table = document.getElementById("items-table-body");
        var numberOfRows = table.rows.length;
        var bc = document.getElementById("stateOfSupply").value;
        if (bc == 'State') {
            document.getElementById('cgstdiv').style.display = 'flex';
            document.getElementById('sgstdiv').style.display = 'flex';
            document.getElementById('igstdiv').style.display = 'none';
            for (var l = 1; l <= numberOfRows; l++) {
                val = document.getElementById('intrataxval' + l).value;
                document.getElementById('tax' + l).value = val
            }
        } else {
            document.getElementById('cgstdiv').style.display = 'none';
            document.getElementById('sgstdiv').style.display = 'none';
            document.getElementById('igstdiv').style.display = 'flex';
            for (var l = 1; l <= numberOfRows; l++) {
                val = document.getElementById('intertaxval' + l).value;
                document.getElementById('tax' + l).value = val
            }
        }
        calc()
    });



    

   

    $(document).ready(function () {
        $('#items-table-body').on('keyup change', function () {
            calc();
        });

        $('#tax').on('keyup change', function () {
            calc_total();
        });
    });

    function calc() {
        $('#tab_logic tbody tr').each(function () {
            var html = $(this).html();
            if (html != '') {
                var qty = $(this).find('.qty').val();
                var price = $(this).find('.price').val();
                var dis = $(this).find('.disc').val();
                var bc = $("#stateOfSupply").val();
                if (bc == 'State') {
                    taxval = $(this).find('.tax').val().slice(3);
                    var tax = parseInt(taxval.match(/\d+/)[0], 10);
                }
                else {
                    taxval = $(this).find('.tax').val().slice(4);
                    var tax = parseInt(taxval.match(/\d+/)[0], 10);
                }
                $(this).find('.total').val((parseFloat(qty) * parseFloat(price)) - parseFloat(dis));
                $(this).find('.taxamount').val(((qty * price) - dis) * (tax / 100));
                calc_total();
            }
        });
    }



    function calc_total() {

        total = 0;
        $('.total').each(function () {
            total += parseFloat($(this).val());
        });
        taxamount = 0;
        $('.taxamount').each(function () {
            taxamount += parseFloat($(this).val());
        });
        $('#sub_total').val(total.toFixed(2));
        $('#tax_amount').val(taxamount.toFixed(2));
        adj_val = parseFloat($('#adj').val());
        gtot = taxamount + total + adj_val;
        $('#grandtotal').val(gtot.toFixed(2));
        $('#baldue').val(gtot.toFixed(2));
        adv_val = parseFloat($('#advance').val());
        adv_val = gtot - adv_val;
        $('#balance').val(adv_val.toFixed(2));
        taxfun();
    }



    function taxfun() {
        var bc = $("#stateOfSupply").val();
        d = 0
        if (bc == 'State') {
            gst = taxamount / 2
            $('#cgst').val(parseFloat(gst.toFixed(2)));
            $('#sgst').val(parseFloat(gst.toFixed(2)));
            $('#igst').val(parseFloat(d.toFixed(2)));
        } else {
            $('#igst').val(taxamount.toFixed(2));
            $('#cgst').val(d.toFixed(2));
            $('#sgst').val(d.toFixed(2));
        }
    }

    var checkbox1 = document.getElementById('inclusive');
    checkbox1.addEventListener('click', function () {
        if (checkbox1.checked) {
            document.getElementById('taxdiv').style.display = 'block';
            document.getElementById('check').checked = false;
        } else {
            document.getElementById('taxdiv').style.display = 'none';
            document.getElementById('intra_st').value = ' ';
            document.getElementById('inter_st').value = ' ';
        }
    });

    var checkbox = document.getElementById('check');
    checkbox.addEventListener('click', function () {
        if (checkbox.checked) {
            document.getElementById('taxdiv').style.display = 'none';
            document.getElementById('inclusive').checked = false;
            document.getElementById('intra_st').value = ' ';
            document.getElementById('inter_st').value = ' ';
        }

    });

    $(document).on("input", "#adj", function () {
        var subtot = $('#sub_total').val();
        var tax = $('#tax_amount').val();
        var adj = $("#adj").val();
        var adv = $("#advance").val();
        $('#grandtotal').val((parseFloat(subtot) + parseFloat(tax) + parseFloat(adj)).toFixed(2));
        $('#balance').val((parseFloat(subtot) + parseFloat(tax) + parseFloat(adj) - parseFloat(adv)).toFixed(2));
    });

    $(document).ready(function () {
        $("#advance").on("input", function () {
            tot_val = parseFloat($('#grandtotal').val())
            adv_val = parseFloat($('#advance').val())
            if (tot_val < adv_val) {
                $('#advance').val(0)
                $('#balance').val(tot_val.toFixed(2));
                alert("Paid Off Greater than Total Amount")
            } else {
                tot_val = tot_val - adv_val
                $('#balance').val(tot_val.toFixed(2));
            }
        });
    });


</script>
<!-- <script>
    var checkbox1 = document.getElementById('inclusive');
    checkbox1.addEventListener('click', function () {
        if (checkbox1.checked) {
            document.getElementById('taxdiv').style.display = 'block';
            document.getElementById('check').checked = false;
        } else {
            document.getElementById('taxdiv').style.display = 'none';
            document.getElementById('intra_st').value = ' ';
            document.getElementById('inter_st').value = ' ';
        }
    });

    var checkbox = document.getElementById('check');
    checkbox.addEventListener('click', function () {
        if (checkbox.checked) {
            document.getElementById('taxdiv').style.display = 'none';
            document.getElementById('inclusive').checked = false;
            document.getElementById('intra_st').value = ' ';
            document.getElementById('inter_st').value = ' ';
        } 

    });
</script>  -->

<script>
    $(document).ready(function () {
        $('#prc_').css({ 'border-bottom': '3px solid rgba(0, 0, 0, 0.548)' })
        $('#stk_ a').removeClass('text-dark')
        $('#prc_ a').addClass('text-dark')
        $('#stk_').css({ 'border-bottom': 'none' })
        $('#pricing_template').attr('hidden', false)

        $('#prc_').on('click', function () {
            $(this).css({ 'border-bottom': '3px solid rgba(0, 0, 0, 0.548)' })
            $('#stk_ a').removeClass('text-dark')
            $('#prc_ a').addClass('text-dark')
            $('#stk_').css({ 'border-bottom': 'none' })
            $('#pricing_template').attr('hidden', false)
            $('#stock_template').attr('hidden', true)
        })
    })

    $(document).ready(function () {
        $('#stk_').on('click', function () {
            $('#stk_').css({ 'border-bottom': '3px solid rgba(0, 0, 0, 0.548)' })
            $('#prc_ a').removeClass('text-dark')
            $('#stk_ a').addClass('text-dark')
            $('#prc_').css({ 'border-bottom': 'none' })
            $('#pricing_template').attr('hidden', true)
            $('#stock_template').attr('hidden', false)
        })
    })

    $(document).ready(function () {
        $('#next_btn').on('click', function () {
            $('#stk_').click()
        })
    })

    $(document).ready(function () {
        $('#prev_btn').on('click', function () {
            $('#prc_').click()
        })
    })


</script>

<script>


    $(document).ready(function () {
        $('#add').click(function () {
            var roinc = $("#items-table-body tr").length;
            roinc++
            $('#items-table-body').append(
                `<tr id='addr0${roinc}'>
                    <td class = 'nnum' style="text-align: center; width:2%"">${roinc}</td>

                    <td style="width:15%">
                        <div class="d-flex">
                            <select name='product[]' id="product${roinc}" class="form-control border-secondary product"  onchange="changeprd(this.id,this.value); checkItem(this)" style="color: black; background-color: white;">
                                <option value="" selected hidden>Select </option>
                                {% for i in item %}
                                  
                                        <option  value="{{ i.id  }}">{{ i.item_name  }} </option>
                                  
                                {% endfor %}
                            </select>&nbsp;&nbsp;&nbsp;

                            <button type="button" class="btn btn-outline-info "  id="modal_closing" data-bs-toggle="modal" data-bs-target="#newitem" data-bs-whatever="@mdo" style="height: 5vh"><i class="fa-solid  fa fa-plus rounded"></i></button>
                        </div>
                    </td>

                    <td tyle="width:12%">
                        <input type="text" name='hsn[]' id="hsn${roinc}" class="form-control border-secondary" style="color: black; background-color: white;" readonly />
                    </td>

                    <td style="width:10%">
                        <input type="number" name='qty[]' value=1 id="qty${roinc}" class="form-control border-secondary qty mb-1" step=0 min=0 style="color: black; background-color: white;" onchange="checkQuantity(this)" />
                    </td>

                    <td tyle="width:12%">
                        <input type="number" name='price[]' id="unit${roinc}" value=0 class="form-control border-secondary price" step="0.00" min="0" style="color: black; background-color: white;" readonly/>
                    </td>

                    <td style='width:15.2%;'>
                        <input type="text" id="intrataxval${roinc}" hidden>
                        <input type="text" id="intertaxval${roinc}" hidden>
                        <input type="text" name='tax[]' id="tax${roinc}"  class="form-control border-secondary tax" style="color: black; background-color: white;" placeholder="GST" readonly/>
                    </td>  
                    

                    <td tyle="width:10.5%">
                        <input type="number" name='discount[]' placeholder='Enter Discount' value=0 id="disc${roinc}" class="form-control border-secondary disc" step=0 min=0 style="color: black; background-color: white;">
                    </td>

                    <td style="width:13%">
                        <input type="number" name='total[]' id="total${roinc}" placeholder=0 class="form-control border-secondary total" value=0 step="any" style="color: black; background-color: white;" readonly />
                    </td>

                    <td hidden><input type="number" step="any" name='taxamount1' id="taxamount${roinc}" class=" taxamount"/></td>
                    
                    <td style="width:1%">
                       
                        
                       
                        <button type='button' id='${roinc}'
                            class='btn btn-transparent btn-outline-danger px-2 mx-1 py-1 remove_row'><i class="fas fa-trash"></i></button>
                                    
                    </td>
                </tr>`
            );
            productsearch(roinc)
            reloadItem(roinc)
        });
    });


    $(document).on('click', '.remove_row', function () {
        var row_id = $(this).attr("id");
        $('#addr0' + row_id + '').remove();
        var table = document.getElementById('tab_logic');
        var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (var i = 0; i < rows.length; i++) {
            var cells = rows[i].getElementsByTagName('td');
            cells[0].innerText = i + 1;
        }
        calc();
    });

    $(document).on('click', '.clone_row', function () {
        var roinc = $("#items-table-body tr").length;
        var originalRow = $(this).closest('#items-table-body tr');
        var clonedRow = originalRow.clone();

        clonedRow.attr('id', 'addr0' + (roinc + 1));

        clonedRow.find('.nnum').text(roinc + 1);

        clonedRow.find('[id]').each(function () {
            var oldId = $(this).attr('id');
            var newId = oldId.replace(/\d+/, roinc + 1);
            console.log(newId)
            $(this).attr('id', newId);
        });

        clonedRow.find('.product').each(function () {
            $(this).val(originalRow.find('.product').val());
        });
        clonedRow.find('.intra_tax').each(function () {
            $(this).val(originalRow.find('.intra_tax').val());
        });
        clonedRow.find('.tax').each(function () {
            $(this).val(originalRow.find('.tax').val());
        });
        originalRow.after(clonedRow);

        var table = document.getElementById('tab_logic');
        var rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
        for (var i = 0; i < rows.length; i++) {
            var cells = rows[i].getElementsByTagName('td');
            cells[0].innerText = i + 1;
        }
        calc();
    });




</script>

<script>
    // check if gstin already exist or not
    $(document).ready(function () {
        $('#gstin').on('input', function () {
            var gst = $(this).val();
            console.log(gst);
            $.ajax({
                type: 'GET',
                url: "{% url 'purchasebill_checkgstin' %}",  
                data: {
                    'gst': gst
                },
                success: function (data) {
                    if (data.exists) {
                        $('#gstError').text('GST Number already exists..');

                    } else {
                        $('#gstError').text('');
                    }
                }
            });
        });
    });

// check if partyphone already exist or not
    $(document).ready(function () {
        $('#partyphno').on('input', function () {
            var ph = $(this).val();
            $.ajax({
                type: 'GET',
                url: "{% url 'purchasebill_checkgphn' %}",  
                data: {
                    'ph': ph
                },
                success: function (data) {
                    if (data.exists) {
                        $('#phnError').text('Phone number already exists..');
                    } else {
                        $('#phnError').text('');
                    }
                }
            });
        });
    });

// check email
    $(document).on('input', '#partyemail', function() {
        var email = $(this).val();
        var emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailPattern.test(email)) {
            $('#emailError').text('Please enter a valid email address.');
        } else {
            $('#emailError').text('');
        }
    });
</script>

<script>
    var invoiceItems = {};

    $(document).ready(function() {
        var initialPartyId = $('#partySelect').val();
        var initialInvNo = $('#inv_no').val();

        // Function to populate invoice items
        function populateInvoiceItems(inv_no) {
            if (inv_no) {
                $.ajax({
                    url: '/get_sale_invoice_details/' + inv_no,
                    method: 'GET',
                    success: function(data) {
                        if (data.status === 'success') {
                            invoiceItems = data.items;
                            var alertMsg = "The following items and quantities were found in the sales invoice:\n";
                            for (var item in invoiceItems) {
                                alertMsg += item + ": " + invoiceItems[item] + "\n";
                            }
                            console.log('Invoice items:', invoiceItems);
                            alert(alertMsg);
                        } else {
                            alert(data.message);
                        }
                    }
                });
            }
        }

        // Populate invoice items on initial load
        populateInvoiceItems(initialInvNo);

        // Event listener for party selection change
        $('#partySelect').change(function() {
            var party_id = $(this).val();
            if (party_id) {
                $.ajax({
                    url: '/get_sale_invoices/' + party_id,
                    method: 'GET',
                    success: function(data) {
                        if (data.status === 'success') {
                            var invoices = data.invoices;
                            var options = '<option value="" selected hidden>Select</option>';
                            invoices.forEach(function(invoice) {
                                options += '<option value="' + invoice.invoice_no + '">' + invoice.invoice_no + '</option>';
                            });
                            $('#inv_no').html(options);
                        } else {
                            alert(data.message);
                        }
                    }
                });
            }
        });

        // Event listener for invoice number change
        $('#inv_no').change(function() {
            var inv_no = $(this).val();
            populateInvoiceItems(inv_no);
        });

        // Event listeners for product and quantity changes
        $(document).on('change', 'select.product', function() {
            checkItem(this);
        });

        $(document).on('input', 'input.qty', function() {
            checkQuantity(this);
        });
    });

    function checkItem(selectElement) {
        var selectedItem = selectElement.options[selectElement.selectedIndex].text.trim();
        var found = false;

        console.log('Checking item:', selectedItem);
        console.log('Invoice items:', invoiceItems);

        for (var item in invoiceItems) {
            console.log('Comparing with item:', item.trim().toLowerCase());
            if (item.trim().toLowerCase() === selectedItem.toLowerCase()) {
                found = true;
                break;
            }
        }

        if (!found) {
            alert('The selected item is not in the sales invoice.');
        }
    }

    function checkQuantity(inputElement) {
        var selectedItem = $(inputElement).closest('tr').find('select.product option:selected').text().trim().toLowerCase();
        var enteredQty = parseFloat(inputElement.value);
        var invoiceQty = 0;

        console.log('Checking quantity for item:', selectedItem);
        console.log('Entered quantity:', enteredQty);
        console.log('Invoice items:', invoiceItems);

        var found = false;

        for (var item in invoiceItems) {
            console.log('Comparing with item:', item.trim().toLowerCase());
            if (item.trim().toLowerCase() === selectedItem) {
                invoiceQty = parseFloat(invoiceItems[item]);
                found = true;
                break;
            }
        }

        if (found) {
            console.log('Invoice quantity:', invoiceQty);
            if (enteredQty > invoiceQty) {
                alert('The quantity entered is greater than the quantity in the sales invoice.');
            } else if (enteredQty < invoiceQty) {
                alert('The quantity entered is less than the quantity in the sales invoice.');
            }
        } else {
            console.warn('Selected item not found in invoice items:', selectedItem);
        }
    }
</script>


<script>
    $(document).ready(function () {
            $("#partySelect").change(function () {
                var party_name = $(this).val();
                if (party_name) {
                    $.ajax({
                        type: 'POST',
                        url: "{% url 'salesinvoicedata' %}",
                        data: {
                            id: party_name,
                            csrfmiddlewaretoken: '{{ csrf_token }}',
                        },
                        success: function (data) {
                            $('#inv_no').empty().append('<option value="" selected hidden>Select</option>');
                            $('#inv_date').empty().append('<option value="" selected hidden>Select</option>');
                            $("#partyPhone").val(data.phone);
                            $("#ava_balance").text(data.balance);

                            if (data.invoice_numbers && data.invoice_dates) {
                                for (var i = 0; i < data.invoice_numbers.length; i++) {
                                    $('#inv_no').append($('<option>', {
                                        value: data.invoice_numbers[i],
                                        text: data.invoice_numbers[i]
                                    }));
                                    $('#inv_date').append($('<option>', {
                                        value: data.invoice_dates[i],
                                        text: data.invoice_dates[i]
                                    }));
                                }
                            } else {
                                $('#inv_no').append($('<option>', {
                                    value: 'No Invoice',
                                    text: 'No Invoice Available'
                                }));
                                $('#inv_date').append($('<option>', {
                                    value: 'No Date',
                                    text: 'No Date Available'
                                }));
                            }
                        },
                        error: function (error) {
                            console.error('AJAX Error:', error);
                        }
                    });

                    $.ajax({
                        type: 'GET',
                        url: "{% url 'get_available_invoices' %}",
                        data: { party_id: party_name },
                        success: function (response) {
                            var available_invoice_numbers = response.available_invoices;
                            $('#inv_no').empty().append('<option value="" selected hidden>Select</option>');
                            available_invoice_numbers.forEach(function (invoice) {
                                $('#inv_no').append('<option value="' + invoice.invoice_no + '">' + invoice.invoice_no + '</option>');
                            });
                        },
                        error: function (error) {
                            console.error('AJAX Error:', error);
                        }
                    });
                }
            });

            $('#inv_no').on('change', function () {
                var selectedInvNo = $(this).val();
                console.log(selectedInvNo);

                $.ajax({
                    type: 'POST',
                    url: "{% url 'get_Invoice_date' %}",
                    data: {
                        inv_no: selectedInvNo,
                        csrfmiddlewaretoken: '{{ csrf_token }}',
                    },
                    success: function (dateData) {
                        $('#inv_date').empty().append('<option value="" selected hidden>Select</option>');

                        if (dateData && dateData.inv_date) {
                            $('#inv_date').append($('<option>', {
                                value: dateData.inv_date,
                                text: dateData.inv_date
                            }));
                        } else {
                            $('#inv_date').append($('<option>', {
                                value: 'No date',
                                text: 'No date available'
                            }));
                        }
                    },
                    error: function (error) {
                        console.error('AJAX Error:', error);
                    }
                });
            });
        });
        
</script>
{% endblock %}